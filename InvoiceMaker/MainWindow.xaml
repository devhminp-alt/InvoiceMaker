<Window x:Class="InvoiceMaker.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:InvoiceMaker.ViewModels"
        Title="Invoice Generator" Height="550" Width="1300">
    <Window.DataContext>
        <vm:InvoiceViewModel />
    </Window.DataContext>

    <Grid x:Name="RootGrid" Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 상단 영역 -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
            <StackPanel Margin="0,0,20,0">
                <TextBlock Text="Invoice Date" />
                <DatePicker SelectedDate="{Binding Invoice.InvoiceDate}" Width="150"/>
            </StackPanel>

            <StackPanel Margin="0,0,20,0">
                <TextBlock Text="Client Name" />
                <TextBox Text="{Binding Invoice.ClientName}" Width="200"/>
            </StackPanel>

            <StackPanel Margin="0,0,20,0">
                <TextBlock Text="Exchange Rate (1 USD = MXN)" />
                <StackPanel Orientation="Horizontal">
                    <TextBox Text="{Binding ExchangeRateUsdToMxn}" Width="120" Margin="0,0,5,0"/>
                    <Button Content="환율 새로고침"
                            Command="{Binding RefreshRateCommand}"/>
                </StackPanel>
            </StackPanel>

            <StackPanel Margin="0,0,20,0">
                <TextBlock Text="Exchange Rate (1 USD = KRW)" />
                <TextBox Text="{Binding ExchangeRateUsdToKrw}" Width="120"/>
            </StackPanel>

            <StackPanel Margin="0,0,20,0">
                <TextBlock Text="할인율(%)" />
                <TextBox Text="{Binding GlobalDiscountPercent}"
                         Width="80"/>
            </StackPanel>

            <StackPanel Margin="20,0,20,0">
                <TextBlock Text="숙박 시작" />
                <DatePicker SelectedDate="{Binding LodgingStartDate}" Width="150"/>
            </StackPanel>

            <StackPanel>
                <TextBlock Text="숙박 종료" />
                <DatePicker SelectedDate="{Binding LodgingEndDate}" Width="150"/>
            </StackPanel>
        </StackPanel>

        <!-- 가운데: 항목 + 버튼 -->
        <Grid Grid.Row="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Button Grid.Row="0"
                    Content="항목 추가"
                    Width="100"
                    Margin="0,0,0,5"
                    HorizontalAlignment="Left"
                    Command="{Binding AddItemCommand}" />

            <DataGrid x:Name="ItemsGrid"
                      Grid.Row="1"
                      ItemsSource="{Binding Items}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      Margin="0,0,0,10"
                      CellEditEnding="DataGrid_CellEditEnding">
                <DataGrid.Columns>
                    <DataGridComboBoxColumn Header="항목 타입"
                        Width="90"
                        SelectedItemBinding="{Binding ItemType, UpdateSourceTrigger=PropertyChanged}">
                        <!-- 표시 모드(읽기) -->
                        <DataGridComboBoxColumn.ElementStyle>
                            <Style TargetType="ComboBox">
                                <Setter Property="ItemsSource"
                    Value="{Binding DataContext.ItemTypes,
                                    RelativeSource={RelativeSource AncestorType=DataGrid}}" />
                            </Style>
                        </DataGridComboBoxColumn.ElementStyle>

                        <!-- 편집 모드(드롭다운 열릴 때) -->
                        <DataGridComboBoxColumn.EditingElementStyle>
                            <Style TargetType="ComboBox">
                                <Setter Property="ItemsSource"
                    Value="{Binding DataContext.ItemTypes,
                                    RelativeSource={RelativeSource AncestorType=DataGrid}}" />
                            </Style>
                        </DataGridComboBoxColumn.EditingElementStyle>
                    </DataGridComboBoxColumn>

                    <!-- 1. 시작일 -->
                    <DataGridTemplateColumn Header="시작일" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding StartDate, StringFormat=yyyy-MM-dd}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <DatePicker SelectedDate="{Binding StartDate, UpdateSourceTrigger=PropertyChanged}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- 2. 종료일 -->
                    <DataGridTemplateColumn Header="종료일" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding EndDate, StringFormat=yyyy-MM-dd}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <DatePicker SelectedDate="{Binding EndDate, UpdateSourceTrigger=PropertyChanged}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <!-- 3. 방 번호 -->
                    <DataGridTextColumn Header="방 번호"
                                        Binding="{Binding RoomNumber, UpdateSourceTrigger=PropertyChanged}"
                                        Width="70"/>

                    <!-- 4. 설명 -->
                    <DataGridTextColumn Header="설명"
                                        Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                        Width="150"/>

                    <!-- 5. 단가(USD) -->
                    <DataGridTextColumn Header="단가(USD)"
                                        Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}"
                                        Width="90"/>

                    <!-- 6. 인원수 -->
                    <DataGridTextColumn Header="인원수"
                                        Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}"
                                        Width="70"/>

                    <!-- 7. dias -->
                    <DataGridTextColumn Header="dias"
                                        Binding="{Binding Days, UpdateSourceTrigger=PropertyChanged}"
                                        Width="60"/>

                    <!-- 8. 할인(%) -->
                    <DataGridTextColumn Header="할인(%)"
                                        Binding="{Binding DiscountPercent, UpdateSourceTrigger=PropertyChanged}"
                                        Width="70"/>

                    <!-- 9. 금액(USD) -->
                    <DataGridTextColumn Header="금액(USD)"
                                        Binding="{Binding AmountUsd, StringFormat=N2}"
                                        IsReadOnly="True"
                                        Width="110"/>

                    <!-- 10. 금액(PESO) -->
                    <DataGridTextColumn Header="금액(PESO)"
                                        Binding="{Binding AmountPeso, StringFormat=N2}"
                                        IsReadOnly="True"
                                        Width="110"/>

                    <!-- 11. 금액(원화) -->
                    <DataGridTextColumn Header="금액(원화)"
                                        Binding="{Binding AmountKrw, StringFormat=N0}"
                                        IsReadOnly="True"
                                        Width="110"/>

                    <!-- 12. 이동 버튼 -->
                    <DataGridTemplateColumn Header="이동" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Content="▲"
                        Padding="2"
                        Margin="0,0,3,0"
                        Command="{Binding DataContext.MoveItemUpCommand,
                                          RelativeSource={RelativeSource AncestorType=DataGrid}}"
                        CommandParameter="{Binding}" />

                                    <Button Content="▼"
                        Padding="2"
                        Command="{Binding DataContext.MoveItemDownCommand,
                                          RelativeSource={RelativeSource AncestorType=DataGrid}}"
                        CommandParameter="{Binding}" />
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- 13. 삭제 버튼 -->
                    <DataGridTemplateColumn Header="삭제" Width="60">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="삭제"
                                        Padding="4,1"
                                        Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <!-- 하단 합계 + 엑셀 버튼 -->
        <StackPanel Grid.Row="2"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center">

            <!-- 합계 -->
            <StackPanel Orientation="Horizontal">
                <StackPanel Margin="0,0,20,0">
                    <TextBlock Text="Total (USD)" />
                    <TextBlock Text="{Binding TotalUsd, StringFormat=N2}"
                               FontSize="16"
                               FontWeight="Bold"
                               HorizontalAlignment="Right"/>
                </StackPanel>
                <StackPanel Margin="0,0,20,0">
                    <TextBlock Text="Total (PESO)" />
                    <TextBlock Text="{Binding TotalPeso, StringFormat=N2}"
                               FontSize="16"
                               FontWeight="Bold"
                               HorizontalAlignment="Right"/>
                </StackPanel>
                <StackPanel>
                    <TextBlock Text="Total (원)" />
                    <TextBlock Text="{Binding TotalKrw, StringFormat=N0}"
                               FontSize="16"
                               FontWeight="Bold"
                               HorizontalAlignment="Right"/>
                </StackPanel>
            </StackPanel>

            <!-- 엑셀 버튼 (합계 오른쪽) -->
            <Button Content="엑셀로 내보내기"
                    Margin="20,0,0,0"
                    Padding="10,3"
                    Command="{Binding ExportToExcelCommand}" />
        </StackPanel>
    </Grid>
</Window>
